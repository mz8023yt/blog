---
title: '[Tiny4412] 搭建 Linux 开发环境'
date: 2018-09-23 22:52:49
tags:
  - tiny4412
  - FrindlyARM
categories: Tiny4412
---

### 前言

最近在学习 V4L2 编程，刚好自己手头上有一块 Tiny4412 的板子和一个免驱的摄像头。因此想在 Tiny4412 的板子上做实验，在实践中学习。  
本文做为第一篇文章，在 Tiny4412 板子上搭建 Linux 系统。

### 一 配置编译烧写 u-boot

#### 1.1 获取 uboot 源码和交叉工具链

uboot 源码和交叉工具链可以在 Tiny4412 附赠的光盘中获取，没有光盘的小伙伴可以访问我的 github 仓库获取。

获取交叉工具链

    user@vmware:~/tiny4412$ git clone git@github.com:tiny4412/FriendlyARM.tool.chain.git

获取 uboot 源码

    user@vmware:~/tiny4412$ git clone git@github.com:tiny4412/FriendlyARM.source.code.git

这里我是直接从光盘中拷贝的，放在 `~/tiny4412` 目录下。

    user@vmware:~/tiny4412$ ls
    arm-linux-gcc-4.5.1-v6-vfp-20120301.tgz   uboot_tiny4412-20130729.tgz

#### 1.2 创建仓库管理 uboot 源码

在 github 上创建一个名为 `FriendlyARM.uboot-2010.12` 的空仓库，克隆到本地

    user@vmware:~/tiny4412$ git clone git@github.com:tiny4412/FriendlyARM.uboot-2010.12.git
    Cloning into 'FriendlyARM.uboot-2010.12'...
    Warning: Permanently added the RSA host key for IP address '192.30.253.112' to the list of known hosts.
    warning: You appear to have cloned an empty repository.
    Checking connectivity... done.

解压 uboot 源码，并将源码移动到仓库目录中进行管理

    user@vmware:~/tiny4412$ tar zxvf uboot_tiny4412-20130729.tgz
    user@vmware:~/tiny4412$ mv uboot_tiny4412/* FriendlyARM.uboot-2010.12/

提交第一笔提交，记录最原始的 uboot 源码状态

    user@vmware:~/tiny4412$ cd FriendlyARM.uboot-2010.12/
    user@vmware:~/tiny4412/FriendlyARM.uboot-2010.12$ make clean
    user@vmware:~/tiny4412/FriendlyARM.uboot-2010.12$ make distclean
    user@vmware:~/tiny4412/FriendlyARM.uboot-2010.12$ git add --all
    user@vmware:~/tiny4412/FriendlyARM.uboot-2010.12$ git commit -m "init: get the u-boot source code by friendly arm"
    user@vmware:~/tiny4412/FriendlyARM.uboot-2010.12$ git push origin -u master

#### 1.3 安装交叉编译器

这里其实也没有什么安装一说，就是将交叉编译器解压出来，后续编译 uboot 的时候，修改 uboot 编译 Makefile 指定交叉编译器用我们现在解压的这个而已

    user@vmware:~/tiny4412$ tar zxvf arm-linux-gcc-4.5.1-v6-vfp-20120301.tgz

#### 1.4 指定 uboot 使用的交叉编译器

通过修改 `arch/arm/config.mk` 指定交叉编译器

    user@vmware:~/tiny4412/FriendlyARM.uboot-2010.12$ git diff
    diff --git a/arch/arm/config.mk b/arch/arm/config.mk
    index 24f8982..a454343 100644
    --- a/arch/arm/config.mk
    +++ b/arch/arm/config.mk
    @@ -21,7 +21,7 @@
     # MA 02111-1307 USA
     #
     
    -CROSS_COMPILE ?= arm-linux-
    +CROSS_COMPILE ?= /home/user/tiny4412/opt/FriendlyARM/toolschain/4.5.1/bin/arm-linux-
     
     ifeq ($(BOARD),omap2420h4)
     STANDALONE_LOAD_ADDR = 0x80300000
    user@vmware:~/tiny4412/FriendlyARM.uboot-2010.12$ git add --all
    user@vmware:~/tiny4412/FriendlyARM.uboot-2010.12$ git commit -m "conf: modify the cross compiler"
    user@vmware:~/tiny4412/FriendlyARM.uboot-2010.12$ git push origin

#### 1.5 配置编译 uboot

配置

    user@vmware:~/tiny4412/FriendlyARM.uboot-2010.12$ make tiny4412_config
    Configuring for tiny4412 board...

编译

    user@vmware:~/tiny4412/FriendlyARM.uboot-2010.12$ make

确认到 u-boot.bin 镜像成功生成

    user@vmware:~/tiny4412/FriendlyARM.uboot-2010.12$ ls -l u-boot.bin 
    -rw-rw-r-- 1 user user 276932 9月  23 22:36 u-boot.bin

#### 1.6 给 u-boot 添加 .gitignore 文件

查看发现全是编译的中间文件，这些文件根本不需使用版本库进行管理，因此我们要忽略它们。随便找一个 kernel 源码中拷贝一个

user@vmware:~/tiny4412/FriendlyARM.uboot-2010.12$ cp ../../mini2440/linux-2.6.22.6/.gitignore ./

将 kernel 默认的忽略文件拷贝到 u-boot 源码中，很好，大部分的中间文件都成功忽略了，但是通过 git st 查看还是有部分中间文件没有被忽略。因此将剩余的中间文件都追加到 .gitignore 文件中。  
需要追加的列表有：

    # don't ignore the .gitignore file
    !.gitignore
    arch/arm/include/asm/arch
    arch/arm/include/asm/proc
    examples/standalone/hello_world
    examples/standalone/hello_world.bin
    examples/standalone/hello_world.srec
    include/autoconf.mk
    include/autoconf.mk.dep
    include/config.h
    include/config.mk
    include/generated/
    include/timestamp_autogenerated.h
    include/version_autogenerated.h
    tools/gen_eth_addr
    tools/img2srec
    tools/mkimage
    u-boot
    u-boot.bin
    u-boot.lds
    u-boot.map
    u-boot.srec

将忽略规则提交

    user@vmware:~/tiny4412/FriendlyARM.uboot-2010.12$ git add --all
    user@vmware:~/tiny4412/FriendlyARM.uboot-2010.12$ git commit -m "conf: add the gitignore rule"
    user@vmware:~/tiny4412/FriendlyARM.uboot-2010.12$ git push origin 

#### 1.7 烧写 uboot

通过 uboot 中提供的脚本可以将 uboot 烧写到 sd 卡中，之后便可以通过 sd 卡启动 uboot。  
另外由于我是在虚拟机上编译的 uboot，因此，sd 卡接在 windows 上，需要在虚拟机右下角找到 sd 卡设备，断开其 windows 主机的连接，让其连接到虚拟机中。  
sd 卡在虚拟机中正确识别后，在 `/dev` 目录下将会自动创建对应的设备节点

sd 卡未接入

    user@vmware:~/tiny4412/FriendlyARM.uboot-2010.12/sd_fuse/tiny4412$ ls /dev/sd*
    /dev/sda  /dev/sda1  /dev/sda2  /dev/sda5

sd 卡接入后

    user@vmware:~/tiny4412/FriendlyARM.uboot-2010.12/sd_fuse/tiny4412$ ls /dev/sd*
    /dev/sda  /dev/sda1  /dev/sda2  /dev/sda5  /dev/sdb  /dev/sdb1

确认到 sd 卡是 `/dev/sdb` 节点后，就可以开始用脚本烧写了，但是烧写依赖 `mkbl2` 镜像，因此要先生成它。
    
    user@vmware:~/tiny4412/FriendlyARM.uboot-2010.12$ cd sd_fuse/
    user@vmware:~/tiny4412/FriendlyARM.uboot-2010.12/sd_fuse$ ls
    Makefile  sd_fdisk.c  tiny4412  V310-EVT1-mkbl2.c
    user@vmware:~/tiny4412/FriendlyARM.uboot-2010.12/sd_fuse$ make 
    gcc -o	mkbl2 V310-EVT1-mkbl2.c 
    gcc -o	sd_fdisk sd_fdisk.c
    user@vmware:~/tiny4412/FriendlyARM.uboot-2010.12/sd_fuse$ ls
    Makefile  mkbl2  sd_fdisk  sd_fdisk.c  tiny4412  V310-EVT1-mkbl2.c

执行烧写脚本烧写 uboot，使用方法为 `./fast_fuse.sh /dev/sdb`

    user@vmware:~/tiny4412/FriendlyARM.uboot-2010.12/sd_fuse$ cd tiny4412/
    user@vmware:~/tiny4412/FriendlyARM.uboot-2010.12/sd_fuse/tiny4412$ ls
    E4412_N.bl1.bin  E4412_tzsw.bin  fast_fuse.sh  sd_fusing.sh
    user@vmware:~/tiny4412/FriendlyARM.uboot-2010.12/sd_fuse/tiny4412$ ./fast_fuse.sh /dev/sdb
    /dev/sdb reader is identified.
    ---------------------------------------
    BL2 fusing
    dd: failed to open '/dev/sdb': Permission denied
    ---------------------------------------
    u-boot fusing
    dd: failed to open '/dev/sdb': Permission denied
    ---------------------------------------
    U-boot image is fused (at 22:45:28) successfully.
    Eject SD card and insert it again.
    user@vmware:~/tiny4412/FriendlyARM.uboot-2010.12/sd_fuse/tiny4412$ sudo ./fast_fuse.sh /dev/sdb
    [sudo] password for user: 
    /dev/sdb reader is identified.
    ---------------------------------------
    BL2 fusing
    28+0 records in
    28+0 records out
    14336 bytes (14 kB, 14 KiB) copied, 0.308954 s, 46.4 kB/s
    ---------------------------------------
    u-boot fusing
    540+1 records in
    540+1 records out
    276932 bytes (277 kB, 270 KiB) copied, 2.91917 s, 94.9 kB/s
    ---------------------------------------
    U-boot image is fused (at 22:45:39) successfully.
    Eject SD card and insert it again.

#### 1.8 用 sd 卡启动验证是否烧录成功

将 SD 卡插入板子中，使用 SD 卡启动，出现如下打印，说明编译烧写成功，如不成功，请仔细 check 上述每一个步骤

    OK

    U-Boot 2010.12-00000-gcfd8b91 (Sep 23 2018 - 22:36:26) for TINY4412


    CPU:	S5PC220 [Samsung SOC on SMP Platform Base on ARM CortexA9]
        APLL = 1400MHz, MPLL = 800MHz

    Board:	TINY4412
    DRAM:	1023 MiB

    vdd_arm: 1.2
    vdd_int: 1.0
    vdd_mif: 1.1

    BL1 version:  N/A (TrustZone Enabled BSP)


    Checking Boot Mode ... SDMMC
    REVISION: 1.1
    MMC Device 0: 7460 MB
    MMC Device 1: 3728 MB
    MMC Device 2: N/A
    *** Warning - using default environment

    Net:	No ethernet found.
    Hit any key to stop autoboot:  0 
    TINY4412 # 
    TINY4412 # 
    TINY4412 # 
    TINY4412 # 

### 二 配置编译烧写 linux 内核

#### 2.1 获取 linux 源码

linux 源码可以在 Tiny4412 附赠的光盘中获取，没有光盘的小伙伴可以访问我的 github 仓库获取。

    user@vmware:~/tiny4412$ git clone git@github.com:tiny4412/FriendlyARM.source.code.git

这里我是直接从光盘中拷贝的，放在 ~/tiny4412 目录下。

    user@vmware:~/tiny4412$ ls
    FriendlyARM.source.code  FriendlyARM.tool.chain  FriendlyARM.uboot-2010.12  linux-3.5-20150929.tgz  opt

#### 2.2 创建仓库管理 linux 源码

在 github 上创建一个名为 `FriendlyARM.linux-3.5` 的空仓库，克隆到本地

    user@vmware:~/tiny4412$ git clone git@github.com:tiny4412/FriendlyARM.linux-3.5.git
    Cloning into 'FriendlyARM.linux-3.5'...
    warning: You appear to have cloned an empty repository.
    Checking connectivity... done.

解压 linux 源码，并将源码移动到仓库目录中进行管理

    user@vmware:~/tiny4412$ tar zxf linux-3.5-20150929.tgz 
    user@vmware:~/tiny4412$ mv linux-3.5/* FriendlyARM.linux-3.5/

提交第一笔提交，记录最原始的 linux 源码状态

    user@vmware:~/tiny4412$ cd FriendlyARM.linux-3.5/
    user@vmware:~/tiny4412/FriendlyARM.linux-3.5$ make clean
    user@vmware:~/tiny4412/FriendlyARM.linux-3.5$ make distclean
    user@vmware:~/tiny4412/FriendlyARM.linux-3.5$ git add --all
    user@vmware:~/tiny4412/FriendlyARM.linux-3.5$ git commit -m "init: get the linux source code by friendly arm"
    user@vmware:~/tiny4412/FriendlyARM.linux-3.5$ git push origin -u master

#### 2.3 指定 linux 使用的交叉编译器

通过修改顶层 Makefile 指定交叉编译器

    user@vmware:~/tiny4412/FriendlyARM.linux-3.5$ git diff
    diff --git a/Makefile b/Makefile
    old mode 100644
    new mode 100755
    index 371e0e4..053f911
    --- a/Makefile
    +++ b/Makefile
    @@ -194,7 +194,7 @@ SUBARCH := $(shell uname -m | sed -e s/i.86/i386/ -e s/sun4u/sparc64/ \
     export KBUILD_BUILDHOST := $(SUBARCH)
     #ARCH          ?= $(SUBARCH)
     ARCH           ?= arm
    -CROSS_COMPILE  ?= $(CONFIG_CROSS_COMPILE:"%"=%)
    +CROSS_COMPILE  ?= /home/user/tiny4412/opt/FriendlyARM/toolschain/4.5.1/bin/arm-linux-
     
     # Architecture as present in compile.h
     UTS_MACHINE    := $(ARCH)
    user@vmware:~/tiny4412/FriendlyARM.linux-3.5$ git add --all
    user@vmware:~/tiny4412/FriendlyARM.linux-3.5$ git commit -m "conf: modify the cross compiler"
    user@vmware:~/tiny4412/FriendlyARM.linux-3.5$ git push origin

#### 2.4 配置内核

修改友善之臂官网提供的配置文件，关闭 trustzone 功能

    user@vmware:~/tiny4412/FriendlyARM.linux-3.5$ git diff
    diff --git a/tiny4412_linux_defconfig b/tiny4412_linux_defconfig
    old mode 100644
    new mode 100755
    index 8da9719..c2b29bd
    --- a/tiny4412_linux_defconfig
    +++ b/tiny4412_linux_defconfig
    @@ -482,7 +482,7 @@ CONFIG_CPU_CP15_MMU=y
     #
     # Processor Features
     #
    -CONFIG_ARM_TRUSTZONE=y
    +# CONFIG_ARM_TRUSTZONE is not set
     # CONFIG_ARM_LPAE is not set
     # CONFIG_ARCH_PHYS_ADDR_T_64BIT is not set
     CONFIG_ARM_THUMB=y
    user@vmware:~/tiny4412/FriendlyARM.linux-3.5$ git add --all
    user@vmware:~/tiny4412/FriendlyARM.linux-3.5$ git commit -m "conf: disable the trustzone"
    user@vmware:~/tiny4412/FriendlyARM.linux-3.5$ git push origin

使用友善之臂提供的配置文件来配置内核

    user@vmware:~/tiny4412/FriendlyARM.linux-3.5$ cp tiny4412_linux_defconfig .config

#### 2.5 编译内核

内核配置好后，直接执行 make 开始编译即可

    user@vmware:~/tiny4412/FriendlyARM.linux-3.5$ make
    ... ...
      TIMEC   kernel/timeconst.h
    Can't use 'defined(@array)' (Maybe you should just omit the defined()?) at kernel/timeconst.pl line 373.
    /home/user/tiny4412/FriendlyARM.linux-3.5/kernel/Makefile:133: recipe for target 'kernel/timeconst.h' failed
    make[1]: *** [kernel/timeconst.h] Error 255
    Makefile:776: recipe for target 'kernel' failed
    make: *** [kernel] Error 2

报错了，不慌，百度了解到需要做如下修改

    user@vmware:~/tiny4412/FriendlyARM.linux-3.5$ git add kernel/timeconst.pl
    user@vmware:~/tiny4412/FriendlyARM.linux-3.5$ git diff --cached 
    diff --git a/kernel/timeconst.pl b/kernel/timeconst.pl
    old mode 100644
    new mode 100755
    index eb51d76..0461239
    --- a/kernel/timeconst.pl
    +++ b/kernel/timeconst.pl
    @@ -370,7 +370,7 @@ if ($hz eq '--can') {
            }
     
            @val = @{$canned_values{$hz}};
    -       if (!defined(@val)) {
    +       if (!@val) {
                    @val = compute_values($hz);
            }
            output($hz, @val);user@vmware:~/tiny4412/FriendlyARM.linux-3.5$ git diff --cached 
    diff --git a/kernel/timeconst.pl b/kernel/timeconst.pl
    old mode 100644
    new mode 100755
    index eb51d76..0461239
    --- a/kernel/timeconst.pl
    +++ b/kernel/timeconst.pl
    @@ -370,7 +370,7 @@ if ($hz eq '--can') {
            }
     
            @val = @{$canned_values{$hz}};
    -       if (!defined(@val)) {
    +       if (!@val) {
                    @val = compute_values($hz);
            }
            output($hz, @val);

修改好后重新 make 成功了，确认到成功生成内核镜像

    user@vmware:~/tiny4412/FriendlyARM.linux-3.5$ ls -l arch/arm/boot/zImage 
    -rwxrwxr-x 1 user user 4783472 9月  24 16:32 arch/arm/boot/zImage

#### 2.6 给 linux 添加 .gitignore 文件

    user@vmware:~/tiny4412/FriendlyARM.linux-3.5$ cp ../FriendlyARM.uboot-2010.12/.gitignore ./

同样，参考 uboot 中修改 ignore 规则一样，还是有部分中间文件没有被忽略。因此将剩余的中间文件都追加到 .gitignore 文件中。并将忽略规则提交

    user@vmware:~/tiny4412/FriendlyARM.linux-3.5$ git add --all
    user@vmware:~/tiny4412/FriendlyARM.linux-3.5$ git commit -m "conf: add the gitignore rule"
    user@vmware:~/tiny4412/FriendlyARM.linux-3.5$ git push origin 

#### 2.7 烧写内核

通过 dd 命令将内核烧写到 SD 卡中，dd 使用格式为：

    dd iflag=dsync oflag=dsync if=<烧写的文件名称> of=<指定烧写的设备> seek=<跳过块数量>

UBOOT默认情况下是从SD卡的1057块开始读取内核映像。  
位置可以随意写，但是不能将前面的UBOOT代码覆盖掉。

    user@vmware:~/tiny4412/FriendlyARM.linux-3.5$ sudo dd iflag=dsync oflag=dsync if=arch/arm/boot/zImage of=/dev/sdb seek=1057
    [sudo] password for user: 
    9342+1 records in
    9342+1 records out
    4783472 bytes (4.8 MB, 4.6 MiB) copied, 42.1633 s, 113 kB/s

#### 2.8 用 sd 卡启动验证是否烧录成功

将 SD 卡插入板子中，使用 SD 卡启动，出现如下打印，说明编译烧写成功，如不成功，请仔细 check 上述每一个步骤

    OK

    U-Boot 2010.12-00000-gbf8103b-dirty (Sep 24 2018 - 09:19:16) for TINY4412


    CPU:	S5PC220 [Samsung SOC on SMP Platform Base on ARM CortexA9]
        APLL = 1400MHz, MPLL = 800MHz

    Board:	TINY4412
    DRAM:	1023 MiB

    vdd_arm: 1.2
    vdd_int: 1.0
    vdd_mif: 1.1

    BL1 version:  N/A (TrustZone Enabled BSP)


    Checking Boot Mode ... SDMMC
    REVISION: 1.1
    MMC Device 0: 7460 MB
    MMC Device 1: 3728 MB
    MMC Device 2: N/A
    *** Warning - using default environment

    Net:	No ethernet found.
    Hit any key to stop autoboot:  0 
    reading kernel..device 0 Start 1057, Count 12288 
    MMC read: dev # 0, block # 1057, count 12288 ... 12288 blocks read: OK
    completed
    reading RFS..device 0 Count 13345, Start 2048 
    MMC read: dev # 0, block # 13345, count 2048 ... 2048 blocks read: OK
    completed
    Boot with zImage
    Wrong Ramdisk Image Format
    [err] boot_get_ramdisk

    Starting kernel ...

    Uncompressing Linux... done, booting the kernel.
    [    0.000000] Booting Linux on physical CPU 0
    [    0.000000] Initializing cgroup subsys cpu
    [    0.000000] Linux version 3.5.0-FriendlyARM-gd4bb223-dirty (user@vmware) (gcc version 4.5.1 (ctng-1.8.1-FA) ) #1 SMP PREEMPT Mon Sep 24 16:31:49 CST 2018

如果此时接了屏幕的话，还可以看到屏幕上出现企鹅图标。

### 三 将 uboot 和内核从 SD 卡中拷贝到 EMMC 中

注意：SD 中有第 0 块不可用，EMMC 第 0 块是可用的，因此从 SD 到 EMMC 中烧的任何代码都需要减去 1
SD 卡是从第一个块开始的， EMMC 是从第0个块开始的

